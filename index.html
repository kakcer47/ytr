<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Telegram Mini App – Дневник iOS 18.1</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Rubik', -apple-system, BlinkMacSystemFont, "San Francisco", "Segoe UI", Roboto, sans-serif;
      background-color: #f8f7f6;
      margin: 0;
      padding: 0;
    }
    .ios-header {
      background: #f8f7f6;
      backdrop-filter: blur(10px);
      border-bottom: 1px solid #D1D1D6;
      box-shadow: 0 1px 0 rgba(0, 0, 0, 0.1);
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 10;
    }
    .search-bar {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background: #f8f7f6;
      backdrop-filter: blur(10px);
      padding: 10px;
      z-index: 15;
      transform: translateY(-100%);
      transition: transform 0.3s ease-in-out;
    }
    .search-bar.active {
      display: block;
      transform: translateY(0);
    }
    .search-bar input {
      width: 100%;
      max-width: 500px;
      margin: 0 auto;
      padding: 8px 12px;
      border: 1px solid #D1D1D6;
      border-radius: 10px;
      font-size: 16px;
      font-family: 'Rubik', sans-serif;
    }
    .search-bar input:focus {
      outline: none;
    }
    .filter-dropdown, .sort-dropdown, .card-menu-dropdown, .header-menu-dropdown {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      background-color: #f8f7f6;
      min-width: 120px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      border-radius: 10px;
      margin-top: 5px;
      z-index: 10;
      opacity: 0;
      transform: translateY(-10px);
      transition: opacity 0.2s ease, transform 0.2s ease;
    }
    
    .sort-dropdown {
      right: 0;
      left: auto;
    }
    .filter-dropdown.show, .sort-dropdown.show, .card-menu-dropdown.show, .header-menu-dropdown.show {
      display: block;
      opacity: 1;
      transform: translateY(0);
    }
    .header-menu-dropdown {
      right: 0;
      left: auto;
      min-width: 160px;
    }
    .card-menu-dropdown {
      bottom: 100%;
      top: auto;
      right: 0;
      left: auto;
      box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.1);
      margin-bottom: 5px;
      margin-top: 0;
      z-index: 20;
      transform: translateY(10px);
    }
    .card-menu-dropdown.show {
      transform: translateY(0);
    }
    .filter-dropdown a:not(.type-option), .sort-dropdown a, .card-menu-dropdown a, .header-menu-dropdown a {
      display: block;
      padding: 8px 12px;
      font-size: 14px;
      color: #000;
      text-decoration: none;
      transition: background-color 0.2s ease;
    }
    .filter-dropdown a:not(.type-option):hover, .sort-dropdown a:hover, .card-menu-dropdown a:hover, .header-menu-dropdown a:hover {
      background-color: #F2F2F7;
      cursor: pointer;
    }
    .filter-dropdown .type-option:hover {
      background-color: #F2F2F7;
      cursor: pointer;
    }
    .filter-dropdown .type-option {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
    }
    .filter-dropdown .type-option .checkmark {
      width: 16px;
      height: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      color: #000;
      margin-left: 4px;
    }
    .filter-label {
      font-size: 10px;
      color: #3c3c43;
      margin-top: 2px;
    }
    .filter-btn, .sort-btn {
      display: inline-flex;
      align-items: center;
      background: none;
      border: none;
      padding: 0;
      cursor: pointer;
      font-size: 14px;
      transition: opacity 0.2s ease;
    }
    .filter-btn:hover, .sort-btn:hover {
      opacity: 0.7;
    }
    .filter-btn img, .sort-btn img {
      width: 18px;
      height: 18px;
    }
    .ios-card {
      background-color: #fcfcfc;
      border-radius: 20px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      transition: all 0.3s ease;
      margin-bottom: 16px;
      transform: translateY(0);
      opacity: 1;
    }
    .ios-card:active {
      background-color: #F2F2F7;
      transform: scale(0.98);
    }
    .ios-card.entering {
      opacity: 0;
      transform: translateY(20px);
    }
    .ios-card.entered {
      opacity: 1;
      transform: translateY(0);
    }
    .ios-title {
      font-size: 18px;
      color: #0a0a0a;
      margin: 4px 0;
      word-wrap: break-word;
      cursor: pointer;
      transition: color 0.2s ease;
    }
    .ios-title:hover {
      color: #007AFF;
    }
    .ios-description-container {
      overflow: hidden;
      transition: all 0.3s ease;
    }
    .ios-description-container.collapsed {
      max-height: 4.2em; /* примерно 3 строки */
      position: relative;
    }
    .ios-description-container.collapsed::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      height: 1.4em;
      width: 100%;
      background: linear-gradient(transparent, #fcfcfc);
      pointer-events: none;
    }
    .ios-description-container.expanded {
      max-height: none;
    }
    .ios-description {
      font-size: 16px;
      color: #3c3c43;
      line-height: 1.4;
      margin: 8px 0 16px;
      word-wrap: break-word;
    }
    .ios-card-footer {
      border-top: 1px solid #D1D1D6;
      padding-top: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .ios-card-footer .user-info {
      display: flex;
      align-items: center;
      font-size: 14px;
      color: #3c3c43;
      cursor: pointer;
      transition: opacity 0.2s ease;
    }
    .ios-card-footer .user-info:hover {
      opacity: 0.7;
    }
    .ios-card-footer .user-info img {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      margin-right: 8px;
    }
    .ios-card-footer .actions {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
    }
    .ios-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 3px;
      margin-bottom: 8px;
    }
    .ios-tag {
      font-size: 10px;
      color: #3c3c43;
      border: 1px solid #D1D1D6;
      border-radius: 10px;
      padding: 2px 6px;
      background: #fcfcfc;
    }
    .floating-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: linear-gradient(135deg, #d97757, #e68a6b);
      color: #fff;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 6px 20px rgba(217, 119, 87, 0.4);
      font-size: 24px;
      cursor: pointer;
      z-index: 20;
      border: none;
      transition: all 0.3s ease;
    }
    .floating-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 8px 25px rgba(217, 119, 87, 0.5);
    }
    .floating-btn:active {
      transform: scale(0.95);
    }
    .modal {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background-color: #f8f7f6;
      border-top-left-radius: 20px;
      border-top-right-radius: 20px;
      box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
      max-width: 500px;
      margin: 0 auto;
      padding: 20px;
      z-index: 30;
      transform: translateY(100%);
      transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
    }
    .modal.active {
      display: block;
      transform: translateY(0);
    }
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 25;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .modal-overlay.active {
      display: block;
      opacity: 1;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 20px;
    }
    .modal-user-info {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
    }
    .modal-user-info img {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      margin-right: 10px;
    }
    .modal-content .input-container {
      position: relative;
      margin-bottom: 12px;
    }
    .modal-content input, .modal-content textarea {
      width: 100%;
      border: 1px solid #D1D1D6;
      border-radius: 10px;
      padding: 12px;
      font-size: 16px;
      font-family: 'Rubik', sans-serif;
      box-sizing: border-box;
      transition: border-color 0.2s ease;
    }
    .modal-content input:focus, .modal-content textarea:focus {
      outline: none;
    }
    .modal-content textarea {
      resize: none;
      height: 120px;
      padding-bottom: 32px;
    }
    .modal-content input {
      padding-right: 60px;
    }
    .counter {
      position: absolute;
      bottom: 8px;
      right: 12px;
      font-size: 11px;
      color: #3c3c43;
      opacity: 0.7;
      pointer-events: none;
      background: rgba(248, 247, 246, 0.9);
      padding: 2px 4px;
      border-radius: 4px;
    }
    .modal-content hr {
      border: 0;
      border-top: 1px solid #D1D1D6;
      margin: 15px 0;
    }
    .modal-submit-btn {
      background: linear-gradient(135deg, #d97757, #e68a6b);
      color: #fcfcfc;
      padding: 10px 20px;
      border-radius: 12px;
      border: none;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .modal-submit-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(217, 119, 87, 0.3);
    }
    .modal-submit-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .loading-indicator {
      display: none;
      text-align: center;
      padding: 20px;
      font-size: 14px;
      color: #3c3c43;
    }
    .loading-indicator.active {
      display: block;
    }
    .loading-spinner {
      border: 2px solid #f3f3f3;
      border-top: 2px solid #007AFF;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .pull-to-refresh {
      transition: transform 0.3s ease;
    }
    .pull-to-refresh.pulling {
      transform: translateY(50px);
    }
    .sort-container {
      position: sticky;
      top: 50px;
      background: #f8f7f6a4;
      backdrop-filter: blur(10px);
      z-index: 5;
      padding: 10px 0;
      padding-right: 8px;
    }
    .hidden {
      display: none;
    }
    .main-content {
      padding-top: 40px;
      padding-bottom: 140px;
      padding-left: 16px;
      padding-right: 16px;
    }
    .header-separator {
      font-size: 10px;
      color: #D1D1D6;
      margin: 0 4px;
    }
    .like-btn {
      display: flex;
      align-items: center;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 14px;
      color: #3C3C4399;
      transition: all 0.2s ease;
    }
    .like-btn.liked {
      color: #d97757;
    }
    .like-btn:hover {
      transform: scale(1.05);
    }
    .like-btn svg {
      width: 20px;
      height: 20px;
      margin-right: 4px;
    }
    .card-menu-btn {
      display: flex;
      align-items: center;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 14px;
      color: #3C3C4399;
      transition: all 0.2s ease;
    }
    .card-menu-btn:hover {
      transform: scale(1.05);
    }
    .relative {
      position: relative;
    }
    .error-message {
      color: #FF3B30;
      font-size: 12px;
      margin-top: 4px;
      display: none;
    }
    .success-message {
      color: #34C759;
      font-size: 12px;
      margin-top: 4px;
      display: none;
    }
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #3c3c43;
    }
    .empty-state svg {
      width: 64px;
      height: 64px;
      margin: 0 auto 16px;
      opacity: 0.5;
    }
  </style>
</head>
<body>
  <header class="ios-header">
    <div class="max-w-md mx-auto px-4 py-2">
      <div class="flex justify-between items-center">
        <div class="flex items-center space-x-2">
          <div class="flex flex-col items-start relative">
            <button id="cityDropdownButton" class="filter-btn focus:outline-none">
              <img src="https://www.svgrepo.com/show/325027/city.svg" alt="город" />
              <span class="ml-1">город</span>
            </button>
            <div id="cityLabel" class="filter-label">все</div>
            <div id="cityDropdownMenu" class="filter-dropdown">
              <a href="#" data-option="все">все</a>
              <a href="#" data-option="Москва">Москва</a>
              <a href="#" data-option="Ростов">Ростов</a>
              <a href="#" data-option="Санкт-Петербург">Санкт-Петербург</a>
            </div>
          </div>
          <span class="header-separator">|</span>
          <div class="flex flex-col items-start relative">
            <button id="typeDropdownButton" class="filter-btn focus:outline-none">
              <img src="https://www.svgrepo.com/show/324884/add-keyframes.svg" alt="тип"/>
              <span class="ml-1">тип</span>
            </button>
            <div id="typeLabel" class="filter-label">все</div>
            <div id="typeDropdownMenu" class="filter-dropdown">
              <a href="#" data-option="все" class="type-option">
                <span>все</span>
                <div class="checkmark"></div>
              </a>
              <a href="#" data-option="Спорт" class="type-option">
                <span>Спорт</span>
                <div class="checkmark"></div>
              </a>
              <a href="#" data-option="Духовность" class="type-option">
                <span>Духовность</span>
                <div class="checkmark"></div>
              </a>
              <a href="#" data-option="Работа" class="type-option">
                <span>Работа</span>
                <div class="checkmark"></div>
              </a>
              <a href="#" data-option="Путешествия" class="type-option">
                <span>Путешествия</span>
                <div class="checkmark"></div>
              </a>
            </div>
          </div>
          <span class="header-separator">|</span>
          <div class="flex flex-col items-start relative">
            <button id="dateDropdownButton" class="filter-btn focus:outline-none">
              <img src="https://www.svgrepo.com/show/324999/calendar.svg" alt="дата"/>
              <span class="ml-1">дата</span>
            </button>
            <div id="dateLabel" class="filter-label">все</div>
            <div id="dateDropdownMenu" class="filter-dropdown">
              <input type="date" id="datePicker" class="text-xs border rounded px-1 py-0.5" />
            </div>
          </div>
          <span class="header-separator">|</span>
          <div class="flex flex-col items-start relative">
            <button id="genderDropdownButton" class="filter-btn focus:outline-none">
              <img src="https://www.svgrepo.com/show/325045/color-filter.svg" alt="пол"/>
              <span class="ml-1">пол</span>
            </button>
            <div id="genderLabel" class="filter-label">все</div>
            <div id="genderDropdownMenu" class="filter-dropdown">
              <a href="#" data-option="Не важно">все</a>
              <a href="#" data-option="Мужчина">Мужчина</a>
              <a href="#" data-option="Женщина">Женщина</a>
            </div>
          </div>
        </div>
        <div class="flex space-x-3">
          <button id="searchButton" class="focus:outline-none">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-4.35-4.35m1.2-6.3a7.5 7.5 0 11-15 0 7.5 7.5 0 0115 0z"/>
            </svg>
          </button>
          <div class="relative">
            <button id="headerMenuButton" class="focus:outline-none">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path d="M6 10c0 1.105-.895 2-2 2s-2-.895-2-2 .895-2 2-2 2 .895 2 2zM12 10c0 1.105-.895 2-2 2s-2-.895-2-2 .895-2 2-2 2 .895 2 2zM18 10c0 1.105-.895 2-2 2s-2-.895-2-2 .895-2 2-2 2 .895 2 2z"/>
              </svg>
            </button>
            <div id="headerMenuDropdown" class="header-menu-dropdown">
              <a href="#" data-option="reset-filters">Сбросить фильтры</a>
              <a href="#" data-option="stars">Звезды</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>
  
  <div class="search-bar" id="searchBar">
    <div class="max-w-md mx-auto">
      <input type="text" id="searchInput" placeholder="Поиск по записям" />
    </div>
  </div>
  
  <div class="loading-indicator max-w-md mx-auto pt-20" id="loadingIndicator">
    <div class="loading-spinner"></div>
    Загрузка...
  </div>
  
  <div class="sort-container max-w-md mx-auto px-4">
    <div class="flex justify-end">
      <div class="relative">
        <button id="sortDropdownButton" class="sort-btn focus:outline-none">
          <img src="https://www.svgrepo.com/show/324932/arrow-separate-vertical.svg" alt="сортировка" />
          <span class="ml-1">сортировка</span>
        </button>
        <div id="sortDropdownMenu" class="sort-dropdown">
          <a href="#" data-option="Мои">Мои</a>
          <a href="#" data-option="Избранное">Избранное</a>
          <a href="#" data-option="Скрытые">Скрытые</a>
          <a href="#" data-option="По рейтингу">По рейтингу</a>
          <a href="#" data-option="Новые">Новые</a>
          <a href="#" data-option="Старые">Старые</a>
        </div>
      </div>
    </div>
  </div>
  
  <main class="main-content max-w-md mx-auto pb-4 space-y-4 pull-to-refresh" id="entriesContainer">
  </main>
  
  <button class="floating-btn" id="addEntryButton">+</button>
  
  <div class="modal-overlay" id="modalOverlay"></div>
  
  <div class="modal" id="modal">
    <div class="modal-header">
      <div class="modal-user-info" id="modalUserInfo"></div>
      <button class="modal-submit-btn" id="modalSubmitButton">Отправить</button>
    </div>
    <div class="flex items-center space-x-2 mb-4">
      <div class="flex flex-col items-start relative">
        <button id="modalCityDropdownButton" class="filter-btn focus:outline-none">
          <img src="https://www.svgrepo.com/show/325027/city.svg" alt="город" />
          <span class="ml-1">город</span>
        </button>
        <div id="modalCityLabel" class="filter-label">все</div>
        <div id="modalCityDropdownMenu" class="filter-dropdown">
          <a href="#" data-option="все">все</a>
          <a href="#" data-option="Москва">Москва</a>
          <a href="#" data-option="Ростов">Ростов</a>
          <a href="#" data-option="Санкт-Петербург">Санкт-Петербург</a>
        </div>
      </div>
      <span class="header-separator">|</span>
      <div class="flex flex-col items-start relative">
        <button id="modalTypeDropdownButton" class="filter-btn focus:outline-none">
          <img src="https://www.svgrepo.com/show/324884/add-keyframes.svg" alt="тип"/>
          <span class="ml-1">тип</span>
        </button>
        <div id="modalTypeLabel" class="filter-label">все</div>
        <div id="modalTypeDropdownMenu" class="filter-dropdown">
          <a href="#" data-option="все" class="type-option">
            <span>все</span>
            <div class="checkmark"></div>
          </a>
          <a href="#" data-option="Спорт" class="type-option">
            <span>Спорт</span>
            <div class="checkmark"></div>
          </a>
          <a href="#" data-option="Духовность" class="type-option">
            <span>Духовность</span>
            <div class="checkmark"></div>
          </a>
          <a href="#" data-option="Работа" class="type-option">
            <span>Работа</span>
            <div class="checkmark"></div>
          </a>
          <a href="#" data-option="Путешествия" class="type-option">
            <span>Путешествия</span>
            <div class="checkmark"></div>
          </a>
        </div>
      </div>
      <span class="header-separator">|</span>
      <div class="flex flex-col items-start relative">
        <button id="modalDateDropdownButton" class="filter-btn focus:outline-none">
          <img src="https://www.svgrepo.com/show/324999/calendar.svg" alt="дата"/>
          <span class="ml-1">дата</span>
        </button>
        <div id="modalDateLabel" class="filter-label">все</div>
        <div id="modalDateDropdownMenu" class="filter-dropdown">
          <input type="date" id="modalDatePicker" class="text-xs border rounded px-1 py-0.5" />
        </div>
      </div>
      <span class="header-separator">|</span>
      <div class="flex flex-col items-start relative">
        <button id="modalGenderDropdownButton" class="filter-btn focus:outline-none">
          <img src="https://www.svgrepo.com/show/325045/color-filter.svg" alt="пол"/>
          <span class="ml-1">пол</span>
        </button>
        <div id="modalGenderLabel" class="filter-label">все</div>
        <div id="modalGenderDropdownMenu" class="filter-dropdown">
          <a href="#" data-option="Не важно">все</a>
          <a href="#" data-option="Мужчина">Мужчина</a>
          <a href="#" data-option="Женщина">Женщина</a>
        </div>
      </div>
    </div>
    <div class="modal-content">
      <div class="input-container">
        <input type="text" id="entryTitle" placeholder="Заголовок записи" maxlength="64" />
        <div id="titleCounter" class="counter">0/64</div>
      </div>
      <div id="titleError" class="error-message">Заголовок обязателен</div>
      
      <div class="input-container">
        <textarea id="entryDescription" placeholder="Описание записи" maxlength="350"></textarea>
        <div id="descriptionCounter" class="counter">0/350</div>
      </div>
      <div id="descriptionError" class="error-message">Описание обязательно</div>
      <div id="successMessage" class="success-message">Запись успешно создана!</div>
    </div>
  </div>

  <script>
    // Утилиты для санитизации
    function sanitizeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // Инициализация данных пользователя
    const currentUser = {
      id: window.Telegram?.WebApp?.initDataUnsafe?.user?.id || Math.floor(Math.random() * 1000000),
      name: window.Telegram?.WebApp?.initDataUnsafe?.user?.first_name || 
            window.Telegram?.WebApp?.initDataUnsafe?.user?.username || "Пользователь",
      avatar: window.Telegram?.WebApp?.initDataUnsafe?.user?.photo_url || 
              `https://ui-avatars.com/api/?name=${encodeURIComponent(
                window.Telegram?.WebApp?.initDataUnsafe?.user?.first_name || 
                window.Telegram?.WebApp?.initDataUnsafe?.user?.username || "Пользователь"
              )}&background=007AFF&color=fff&size=64`
    };

    // Отладочная информация для разработки
    if (window.Telegram?.WebApp) {
      console.log("Telegram WebApp доступен:", window.Telegram.WebApp);
      console.log("Пользователь:", window.Telegram.WebApp.initDataUnsafe?.user);
      console.log("Текущий пользователь:", currentUser);
    } else {
      console.log("Telegram WebApp недоступен, используются демо данные");
    }

    const sampleUsers = [
      { id: 2, name: "Алексей", avatar: "https://ui-avatars.com/api/?name=Алексей&background=34C759&color=fff&size=64" },
      { id: 3, name: "Мария", avatar: "https://ui-avatars.com/api/?name=Мария&background=FF9500&color=fff&size=64" },
      { id: 4, name: "Дмитрий", avatar: "https://ui-avatars.com/api/?name=Дмитрий&background=FF3B30&color=fff&size=64" },
      { id: 5, name: "Анна", avatar: "https://ui-avatars.com/api/?name=Анна&background=AF52DE&color=fff&size=64" }
    ];

    let favorites = new Set();
    let hiddenEntries = new Set();
    let selectedTypes = new Set(['все']);
    let modalSelectedTypes = new Set(['все']);
    let entries = [
      {
        id: 1,
        title: "Запись от 06 июня 2025",
        description: "Сегодня я посвятил время саморазвитию и размышлениям. Читал книгу о медитации и практиковал осознанность. Это помогло мне найти внутренний покой и лучше понять себя.",
        tags: { city: "Москва", type: ["Духовность"], date: "2025-06-06", gender: "Не важно" },
        creator: sampleUsers[0],
        likedBy: [currentUser.id],
        timestamp: new Date('2025-06-06T12:00:00')
      },
      {
        id: 2,
        title: "Спортивная тренировка",
        description: "Отличная тренировка в спортзале сегодня! Фокусировался на силовых упражнениях и завершил кардио. Чувствую прилив энергии и готовность к новым вызовам.",
        tags: { city: "Ростов", type: ["Спорт"], date: "2025-06-05", gender: "Мужчина" },
        creator: sampleUsers[1],
        likedBy: [sampleUsers[2].id],
        timestamp: new Date('2025-06-05T18:30:00')
      },
      {
        id: 3,
        title: "Вечерние размышления",
        description: "Прекрасный закат сегодня напомнил о красоте момента. Время подумать о целях на будущее и планах на завтра. Благодарна за этот день.",
        tags: { city: "Москва", type: ["Духовность"], date: "2025-06-04", gender: "Женщина" },
        creator: sampleUsers[2],
        likedBy: [sampleUsers[0].id, currentUser.id],
        timestamp: new Date('2025-06-04T20:15:00')
      },
      {
        id: 4,
        title: "Рабочий проект",
        description: "Завершил важный проект на работе. Командная работа показала отличные результаты, и я горжусь тем, что мы достигли.",
        tags: { city: "Санкт-Петербург", type: ["Работа"], date: "2025-06-03", gender: "Мужчина" },
        creator: sampleUsers[3],
        likedBy: [sampleUsers[1].id],
        timestamp: new Date('2025-06-03T15:45:00')
      }
    ];

    // Глобальные переменные состояния
    let currentPage = 1;
    const entriesPerPage = 25;
    let filters = { 
      city: "все", 
      type: new Set(['все']), 
      date: "все", 
      gender: "Не важно", 
      search: "",
      creator: null,
      favorite: false,
      hidden: false
    };
    let currentSort = "Новые";
    let isLoading = false;

    // DOM элементы
    const entriesContainer = document.getElementById("entriesContainer");
    const loadingIndicator = document.getElementById("loadingIndicator");
    const searchButton = document.getElementById("searchButton");
    const searchBar = document.getElementById("searchBar");
    const searchInput = document.getElementById("searchInput");
    const modal = document.getElementById("modal");
    const modalOverlay = document.getElementById("modalOverlay");
    const addEntryButton = document.getElementById("addEntryButton");
    const modalSubmitButton = document.getElementById("modalSubmitButton");
    const entryTitle = document.getElementById("entryTitle");
    const entryDescription = document.getElementById("entryDescription");

    // Утилиты
    function toggleDropdown(menu) {
      const isOpen = menu.classList.contains('show');
      closeAllDropdowns();
      if (!isOpen) {
        menu.style.display = "block";
        setTimeout(() => menu.classList.add('show'), 10);
      }
    }

    function closeAllDropdowns() {
      document.querySelectorAll(".filter-dropdown, .sort-dropdown, .card-menu-dropdown, .header-menu-dropdown").forEach(menu => {
        menu.classList.remove('show');
        setTimeout(() => {
          if (!menu.classList.contains('show')) {
            menu.style.display = "none";
          }
        }, 200);
      });
    }

    function formatDate(date) {
      return new Intl.DateTimeFormat('ru-RU', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
      }).format(date);
    }

    function validateForm() {
      const title = entryTitle.value.trim();
      const description = entryDescription.value.trim();
      let isValid = true;

      // Скрыть все сообщения об ошибках
      document.querySelectorAll('.error-message, .success-message').forEach(el => {
        el.style.display = 'none';
      });

      if (!title) {
        document.getElementById('titleError').style.display = 'block';
        isValid = false;
      }

      if (!description) {
        document.getElementById('descriptionError').style.display = 'block';
        isValid = false;
      }

      return isValid;
    }

    function updateTypeFilter(isModal = false) {
      const selectedSet = isModal ? modalSelectedTypes : selectedTypes;
      const label = isModal ? document.getElementById('modalTypeLabel') : document.getElementById('typeLabel');
      
      if (selectedSet.has('все') || selectedSet.size === 0) {
        label.textContent = 'все';
      } else if (selectedSet.size === 1) {
        label.textContent = 'выбрано';
      } else {
        label.textContent = `выбрано (${selectedSet.size})`;
      }
    }

    function updateTypeCheckmarks(menuId, selectedSet) {
      const menu = document.getElementById(menuId);
      menu.querySelectorAll('.type-option').forEach(option => {
        const value = option.dataset.option;
        const checkmark = option.querySelector('.checkmark');
        
        if (selectedSet.has(value)) {
          checkmark.textContent = '✓';
        } else {
          checkmark.textContent = '';
        }
      });
    }

    // Функция для обновления отдельной карточки без перерендера всей ленты
    function updateEntryCard(entryId) {
      const cardElement = document.querySelector(`[data-entry-id="${entryId}"]`);
      if (!cardElement) return;

      const entry = entries.find(e => e.id === entryId);
      if (!entry) return;

      // Обновляем только лайки
      const likeBtn = cardElement.querySelector('.like-btn');
      const isLiked = entry.likedBy.includes(currentUser.id);
      
      if (isLiked) {
        likeBtn.classList.add('liked');
        likeBtn.querySelector('svg').setAttribute('fill', 'currentColor');
      } else {
        likeBtn.classList.remove('liked');
        likeBtn.querySelector('svg').setAttribute('fill', 'none');
      }
      
      likeBtn.querySelector('span').textContent = entry.likedBy.length;
    }

    // Рендеринг записей
    function renderEntry(entry) {
      const entryElement = document.createElement("div");
      entryElement.classList.add("ios-card", "entering");
      entryElement.dataset.entryId = entry.id;
      
      const isLiked = entry.likedBy.includes(currentUser.id);
      const isFavorited = favorites.has(entry.id);
      const isOwner = entry.creator.id === currentUser.id;

      // Обработка тегов типа (может быть массив)
      const typeTags = Array.isArray(entry.tags.type) ? entry.tags.type : [entry.tags.type];

      entryElement.innerHTML = `
        <div class="ios-tags">
          ${entry.tags.city !== "все" ? `<span class="ios-tag">${sanitizeHtml(entry.tags.city)}</span>` : ""}
          ${typeTags.filter(type => type !== "все").map(type => `<span class="ios-tag">${sanitizeHtml(type)}</span>`).join("")}
          ${entry.tags.date !== "все" ? `<span class="ios-tag">${sanitizeHtml(entry.tags.date)}</span>` : ""}
          ${entry.tags.gender !== "Не важно" ? `<span class="ios-tag">${sanitizeHtml(entry.tags.gender)}</span>` : ""}
        </div>
        <h2 class="ios-title">${sanitizeHtml(entry.title)}</h2>
        <div class="ios-description-container collapsed">
          <p class="ios-description">${sanitizeHtml(entry.description)}</p>
        </div>
        <div class="ios-card-footer">
          <div class="user-info" data-user-id="${entry.creator.id}">
            <img src="${entry.creator.avatar}" alt="avatar" loading="lazy" />
            <span>${sanitizeHtml(entry.creator.name)}</span>
          </div>
          <div class="actions">
            <button class="like-btn ${isLiked ? 'liked' : ''}" data-entry-id="${entry.id}">
              <svg viewBox="0 0 24 24" fill="${isLiked ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2">
                <path d="M8.58737 8.23597L11.1849 3.00376C11.5183 2.33208 12.4817 2.33208 12.8151 3.00376L15.4126 8.23597L21.2215 9.08017C21.9668 9.18848 22.2638 10.0994 21.7243 10.6219L17.5217 14.6918L18.5135 20.4414C18.6409 21.1798 17.8614 21.7428 17.1945 21.3941L12 18.678L6.80547 21.3941C6.1386 21.7428 5.35909 21.1798 5.48645 20.4414L6.47825 14.6918L2.27575 10.6219C1.73617 10.0994 2.03322 9.18848 2.77852 9.08017L8.58737 8.23597Z" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              <span>${entry.likedBy.length}</span>
            </button>
            <div class="relative">
              <button class="card-menu-btn focus:outline-none">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M6 10c0 1.105-.895 2-2 2s-2-.895-2-2 .895-2 2-2 2 .895 2 2zM12 10c0 1.105-.895 2-2 2s-2-.895-2-2 .895-2 2-2 2 .895 2 2zM18 10c0 1.105-.895 2-2 2s-2-.895-2-2 .895-2 2-2 2 .895 2 2z"/>
                </svg>
              </button>
              <div class="card-menu-dropdown">
                ${isOwner ? '<a href="#" data-option="Изменить">Изменить</a>' : ''}
                ${isOwner ? '<a href="#" data-option="Удалить">Удалить</a>' : ''}
                ${!isOwner ? '<a href="#" data-option="Скрыть">Скрыть</a>' : ''}
                ${!isOwner ? `<a href="#" data-option="favorite">${isFavorited ? "Удалить из избранного" : "В избранное"}</a>` : ''}
              </div>
            </div>
          </div>
        </div>
      `;

      // Анимация появления
      setTimeout(() => {
        entryElement.classList.remove('entering');
        entryElement.classList.add('entered');
      }, 50);

      return entryElement;
    }

    function renderEmptyState() {
      const emptyElement = document.createElement("div");
      emptyElement.classList.add("empty-state");
      emptyElement.innerHTML = `
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
        </svg>
        <h3 style="margin: 0 0 8px 0; font-size: 18px; font-weight: 500;">Записей не найдено</h3>
        <p style="margin: 0; font-size: 14px; opacity: 0.7;">Попробуйте изменить фильтры или создать новую запись</p>
      `;
      return emptyElement;
    }

    function applyFilters(entriesList) {
      return entriesList.filter(entry => {
        const searchLower = filters.search.toLowerCase();
        const matchesSearch = !filters.search || 
          entry.title.toLowerCase().includes(searchLower) || 
          entry.description.toLowerCase().includes(searchLower) ||
          entry.creator.name.toLowerCase().includes(searchLower);

        // Проверка типов
        const entryTypes = Array.isArray(entry.tags.type) ? entry.tags.type : [entry.tags.type];
        const matchesType = filters.type.has('все') || 
          entryTypes.some(type => filters.type.has(type));

        // Проверка скрытых записей
        const isHidden = hiddenEntries.has(entry.id);
        const matchesHidden = filters.hidden ? isHidden : !isHidden;

        return (
          (filters.city === "все" || entry.tags.city === filters.city) &&
          matchesType &&
          (filters.date === "все" || entry.tags.date === filters.date) &&
          (filters.gender === "Не важно" || entry.tags.gender === filters.gender) &&
          matchesSearch &&
          (!filters.creator || entry.creator.id === filters.creator) &&
          (!filters.favorite || favorites.has(entry.id)) &&
          matchesHidden
        );
      });
    }

    function applySorting(entriesList) {
      const sorted = [...entriesList];
      
      switch (currentSort) {
        case "Новые":
          filters.hidden = false;
          return sorted.sort((a, b) => b.timestamp - a.timestamp);
        case "Старые":
          filters.hidden = false;
          return sorted.sort((a, b) => a.timestamp - b.timestamp);
        case "По рейтингу":
          filters.hidden = false;
          return sorted.sort((a, b) => b.likedBy.length - a.likedBy.length);
        case "Мои":
          filters.hidden = false;
          return sorted.filter(entry => entry.creator.id === currentUser.id)
                      .sort((a, b) => b.timestamp - a.timestamp);
        case "Избранное":
          filters.hidden = false;
          return sorted.filter(entry => favorites.has(entry.id))
                      .sort((a, b) => b.timestamp - a.timestamp);
        case "Скрытые":
          filters.hidden = true;
          return sorted.filter(entry => hiddenEntries.has(entry.id))
                      .sort((a, b) => b.timestamp - a.timestamp);
        default:
          return sorted;
      }
    }

    function renderEntries(pageEntries) {
      if (pageEntries.length === 0 && currentPage === 1) {
        entriesContainer.appendChild(renderEmptyState());
        return;
      }

      pageEntries.forEach((entry, index) => {
        setTimeout(() => {
          entriesContainer.appendChild(renderEntry(entry));
        }, index * 50); // Staggered animation
      });
    }

    function loadEntries() {
      if (isLoading) return;
      isLoading = true;
      loadingIndicator.classList.add("active");
      
      setTimeout(() => {
        // Применяем фильтры и сортировку
        let filteredEntries = applyFilters(entries);
        filteredEntries = applySorting(filteredEntries);
        
        // Пагинация
        const start = (currentPage - 1) * entriesPerPage;
        const end = start + entriesPerPage;
        const pageEntries = filteredEntries.slice(start, end);
        
        renderEntries(pageEntries);
        loadingIndicator.classList.remove("active");
        isLoading = false;
      }, 300);
    }

    function refreshEntries() {
      entriesContainer.innerHTML = "";
      const sentinel = document.createElement("div");
      sentinel.style.height = "1px";
      entriesContainer.appendChild(sentinel);
      observer.observe(sentinel);
      currentPage = 1;
      loadEntries();
    }

    // Обработчики событий для фильтров
    function setupFilter(buttonId, menuId, labelId, filterKey) {
      const button = document.getElementById(buttonId);
      const menu = document.getElementById(menuId);
      const label = document.getElementById(labelId);

      button.addEventListener("click", function(e) {
        e.stopPropagation();
        toggleDropdown(menu);
      });

      menu.querySelectorAll("a").forEach(item => {
        item.addEventListener("click", function(e) {
          e.preventDefault();
          const value = this.dataset.option;
          label.textContent = value === "все" || value === "Не важно" ? "все" : "выбрано";
          filters[filterKey] = value;
          refreshEntries();
          closeAllDropdowns();
        });
      });
    }

    function setupModalFilter(buttonId, menuId, labelId) {
      const button = document.getElementById(buttonId);
      const menu = document.getElementById(menuId);
      const label = document.getElementById(labelId);

      button.addEventListener("click", function(e) {
        e.stopPropagation();
        toggleDropdown(menu);
      });

      menu.querySelectorAll("a").forEach(item => {
        item.addEventListener("click", function(e) {
          e.preventDefault();
          const value = this.dataset.option;
          label.textContent = value === "все" || value === "Не важно" ? "все" : "выбрано";
          label.dataset.value = value;
          closeAllDropdowns();
        });
      });
    }

    // Настройка фильтров
    setupFilter("cityDropdownButton", "cityDropdownMenu", "cityLabel", "city");
    setupFilter("genderDropdownButton", "genderDropdownMenu", "genderLabel", "gender");

    setupModalFilter("modalCityDropdownButton", "modalCityDropdownMenu", "modalCityLabel");
    setupModalFilter("modalGenderDropdownButton", "modalGenderDropdownMenu", "modalGenderLabel");

    // Специальная настройка для типов
    function setupTypeFilter(buttonId, menuId, labelId, isModal = false) {
      const button = document.getElementById(buttonId);
      const menu = document.getElementById(menuId);
      const selectedSet = isModal ? modalSelectedTypes : selectedTypes;

      button.addEventListener("click", function(e) {
        e.stopPropagation();
        toggleDropdown(menu);
        updateTypeCheckmarks(menuId, selectedSet);
      });

      menu.querySelectorAll('.type-option').forEach(item => {
        item.addEventListener("click", function(e) {
          e.preventDefault();
          const value = this.dataset.option;
          
          if (value === 'все') {
            selectedSet.clear();
            selectedSet.add('все');
          } else {
            if (selectedSet.has('все')) {
              selectedSet.delete('все');
            }
            
            if (selectedSet.has(value)) {
              selectedSet.delete(value);
            } else if (selectedSet.size < 3) {
              selectedSet.add(value);
            }
            
            if (selectedSet.size === 0) {
              selectedSet.add('все');
            }
          }
          
          updateTypeCheckmarks(menuId, selectedSet);
          updateTypeFilter(isModal);
          
          if (!isModal) {
            filters.type = new Set(selectedSet);
            refreshEntries();
          }
        });
      });
    }

    setupTypeFilter("typeDropdownButton", "typeDropdownMenu", "typeLabel", false);
    setupTypeFilter("modalTypeDropdownButton", "modalTypeDropdownMenu", "modalTypeLabel", true);

    // Обработчик для даты
    const dateButton = document.getElementById("dateDropdownButton");
    const dateMenu = document.getElementById("dateDropdownMenu");
    const dateLabel = document.getElementById("dateLabel");
    const datePicker = document.getElementById("datePicker");

    dateButton.addEventListener("click", function(e) {
      e.stopPropagation();
      toggleDropdown(dateMenu);
      setTimeout(() => {
        datePicker.focus();
      }, 100);
    });

    datePicker.addEventListener("change", function() {
      const selectedDate = this.value;
      dateLabel.textContent = selectedDate ? "выбрано" : "все";
      filters.date = selectedDate || "все";
      refreshEntries();
      closeAllDropdowns();
    });

    // Модальное окно для даты
    const modalDateButton = document.getElementById("modalDateDropdownButton");
    const modalDateMenu = document.getElementById("modalDateDropdownMenu");
    const modalDateLabel = document.getElementById("modalDateLabel");
    const modalDatePicker = document.getElementById("modalDatePicker");

    modalDateButton.addEventListener("click", function(e) {
      e.stopPropagation();
      toggleDropdown(modalDateMenu);
      setTimeout(() => {
        modalDatePicker.focus();
      }, 100);
    });

    modalDatePicker.addEventListener("change", function() {
      modalDateLabel.textContent = this.value ? "выбрано" : "все";
      closeAllDropdowns();
    });

    // Поиск с дебаунсингом
    const debouncedSearch = debounce(() => {
      filters.search = searchInput.value;
      refreshEntries();
    }, 300);

    searchButton.addEventListener("click", () => {
      searchBar.classList.toggle("active");
      if (searchBar.classList.contains("active")) {
        searchInput.focus();
      } else {
        searchInput.value = "";
        filters.search = "";
        refreshEntries();
      }
    });

    searchInput.addEventListener("input", debouncedSearch);

    // Сортировка
    const sortButton = document.getElementById("sortDropdownButton");
    const sortMenu = document.getElementById("sortDropdownMenu");

    sortButton.addEventListener("click", function(e) {
      e.stopPropagation();
      toggleDropdown(sortMenu);
    });

    sortMenu.querySelectorAll("a").forEach(item => {
      item.addEventListener("click", function(e) {
        e.preventDefault();
        currentSort = this.dataset.option;
    
        // Сброс специальных фильтров при обычной сортировке
        if (currentSort !== "Мои" && currentSort !== "Избранное" && currentSort !== "Скрытые") {
          filters.creator = null;
          filters.favorite = false;
          filters.hidden = false;
        }
    
        // Обновляем текст кнопки
        sortButton.querySelector("span").textContent = this.textContent;
    
        refreshEntries();
        closeAllDropdowns();
      });
    });

    // Меню в шапке
    const headerMenuButton = document.getElementById("headerMenuButton");
    const headerMenuDropdown = document.getElementById("headerMenuDropdown");

    headerMenuButton.addEventListener("click", function(e) {
      e.stopPropagation();
      toggleDropdown(headerMenuDropdown);
    });

    headerMenuDropdown.querySelectorAll("a").forEach(item => {
      item.addEventListener("click", function(e) {
        e.preventDefault();
        const action = this.dataset.option;
        
        if (action === "reset-filters") {
          // Сброс всех фильтров
          filters = { 
            city: "все", 
            type: new Set(['все']), 
            date: "все", 
            gender: "Не важно", 
            search: "",
            creator: null,
            favorite: false,
            hidden: false
          };
          selectedTypes.clear();
          selectedTypes.add('все');
          
          // Обновление UI
          document.getElementById("cityLabel").textContent = "все";
          document.getElementById("typeLabel").textContent = "все";
          document.getElementById("dateLabel").textContent = "все";
          document.getElementById("genderLabel").textContent = "все";
          searchInput.value = "";
          datePicker.value = "";
          
          updateTypeCheckmarks("typeDropdownMenu", selectedTypes);
          refreshEntries();
        } else if (action === "stars") {
          // Заглушка для звезд
          alert("Функция 'Звезды' пока недоступна");
        }
        
        closeAllDropdowns();
      });
    });

    // Счетчики символов
    entryTitle.addEventListener("input", function() {
      const current = this.value.length;
      document.getElementById("titleCounter").textContent = `${current}/64`;
    });

    entryDescription.addEventListener("input", function() {
      const current = this.value.length;
      document.getElementById("descriptionCounter").textContent = `${current}/350`;
    });

    // Модальное окно
    addEntryButton.addEventListener("click", function() {
      document.getElementById("modalUserInfo").innerHTML = `
        <img src="${currentUser.avatar}" alt="avatar" />
        <span>${sanitizeHtml(currentUser.name)}</span>
      `;
      
      // Сброс формы
      entryTitle.value = "";
      entryDescription.value = "";
      document.getElementById("modalCityLabel").textContent = "все";
      document.getElementById("modalTypeLabel").textContent = "все";
      document.getElementById("modalDateLabel").textContent = "все";
      document.getElementById("modalGenderLabel").textContent = "все";
      modalDatePicker.value = "";
      
      // Сброс типов
      modalSelectedTypes.clear();
      modalSelectedTypes.add('все');
      updateTypeCheckmarks("modalTypeDropdownMenu", modalSelectedTypes);
      updateTypeFilter(true);
      
      // Сброс счетчиков
      document.getElementById("titleCounter").textContent = "0/64";
      document.getElementById("descriptionCounter").textContent = "0/350";
      
      // Скрыть сообщения об ошибках
      document.querySelectorAll('.error-message, .success-message').forEach(el => {
        el.style.display = 'none';
      });
      
      modal.classList.add("active");
      modalOverlay.classList.add("active");
      entryTitle.focus();
    });

    modalOverlay.addEventListener("click", function() {
      modal.classList.remove("active");
      modalOverlay.classList.remove("active");
    });

    modalSubmitButton.addEventListener("click", function() {
      if (!validateForm()) return;

      modalSubmitButton.disabled = true;
      modalSubmitButton.textContent = "Отправка...";

      const city = document.getElementById("modalCityLabel").dataset.value || "все";
      const selectedTypesArray = modalSelectedTypes.has('все') ? ['все'] : Array.from(modalSelectedTypes);
      const gender = document.getElementById("modalGenderLabel").dataset.value || "Не важно";
      const date = modalDatePicker.value || "все";

      const newEntry = {
        id: Math.max(...entries.map(e => e.id), 0) + 1,
        title: entryTitle.value.trim() || `Запись от ${formatDate(new Date())}`,
        description: entryDescription.value.trim() || "Описание отсутствует",
        tags: { city, type: selectedTypesArray, date, gender },
        creator: currentUser,
        likedBy: [],
        timestamp: new Date()
      };

      setTimeout(() => {
        entries.unshift(newEntry);
        
        // Показать сообщение об успехе
        document.getElementById('successMessage').style.display = 'block';
        
        setTimeout(() => {
          modal.classList.remove("active");
          modalOverlay.classList.remove("active");
          modalSubmitButton.disabled = false;
          modalSubmitButton.textContent = "Отправить";
          refreshEntries();
        }, 1000);
      }, 500);
    });

    // Обработчики действий с записями
    entriesContainer.addEventListener("click", function(e) {
      // Разворачивание описания при клике на заголовок
      const title = e.target.closest(".ios-title");
      if (title) {
        e.stopPropagation();
        const card = title.closest(".ios-card");
        const descContainer = card.querySelector(".ios-description-container");
        
        if (descContainer.classList.contains('collapsed')) {
          descContainer.classList.remove('collapsed');
          descContainer.classList.add('expanded');
        } else {
          descContainer.classList.remove('expanded');
          descContainer.classList.add('collapsed');
        }
        return;
      }

      // Лайки
      const likeBtn = e.target.closest(".like-btn");
      if (likeBtn) {
        const entryId = parseInt(likeBtn.dataset.entryId);
        const entry = entries.find(e => e.id === entryId);
        if (entry) {
          if (entry.likedBy.includes(currentUser.id)) {
            entry.likedBy = entry.likedBy.filter(id => id !== currentUser.id);
          } else {
            entry.likedBy.push(currentUser.id);
          }
          
          // Анимация лайка
          likeBtn.style.transform = 'scale(1.2)';
          setTimeout(() => {
            likeBtn.style.transform = 'scale(1)';
          }, 150);
          
          // Обновляем только эту карточку
          updateEntryCard(entryId);
        }
        return;
      }

      // Меню карточки
      const menuButton = e.target.closest(".card-menu-btn");
      if (menuButton) {
        e.stopPropagation();
        const dropdown = menuButton.nextElementSibling;
        toggleDropdown(dropdown);
        return;
      }

      // Действия меню
      const menuItem = e.target.closest(".card-menu-dropdown a");
      if (menuItem) {
        e.preventDefault();
        const entryElement = menuItem.closest(".ios-card");
        const entryId = parseInt(entryElement.dataset.entryId);
        const option = menuItem.dataset.option;
        
        if (option === "favorite") {
          if (favorites.has(entryId)) {
            favorites.delete(entryId);
          } else {
            favorites.add(entryId);
          }
          // Не обновляем всю ленту, только обновляем меню
          const entry = entries.find(e => e.id === entryId);
          const isFavorited = favorites.has(entryId);
          menuItem.textContent = isFavorited ? "Удалить из избранного" : "В избранное";
        } else if (option === "Удалить") {
          if (confirm("Вы уверены, что хотите удалить эту запись?")) {
            entries = entries.filter(entry => entry.id !== entryId);
            entryElement.style.transform = 'translateX(-100%)';
            entryElement.style.opacity = '0';
            setTimeout(() => {
              entryElement.remove();
            }, 300);
          }
        } else if (option === "Скрыть") {
          hiddenEntries.add(entryId);
          entryElement.style.transform = 'translateX(-100%)';
          entryElement.style.opacity = '0';
          setTimeout(() => {
            entryElement.remove();
          }, 300);
        } else if (option === "Изменить") {
          const entry = entries.find(entry => entry.id === entryId);
          if (entry && entry.creator.id === currentUser.id) {
            // Заполняем форму данными записи
            entryTitle.value = entry.title;
            entryDescription.value = entry.description;
            
            // Обновляем счетчики
            document.getElementById("titleCounter").textContent = `${entry.title.length}/64`;
            document.getElementById("descriptionCounter").textContent = `${entry.description.length}/350`;
            
            document.getElementById("modalCityLabel").textContent = entry.tags.city === "все" ? "все" : "выбрано";
            document.getElementById("modalCityLabel").dataset.value = entry.tags.city;
            
            // Настройка типов
            modalSelectedTypes.clear();
            const entryTypes = Array.isArray(entry.tags.type) ? entry.tags.type : [entry.tags.type];
            entryTypes.forEach(type => modalSelectedTypes.add(type));
            updateTypeCheckmarks("modalTypeDropdownMenu", modalSelectedTypes);
            updateTypeFilter(true);
            
            document.getElementById("modalGenderLabel").textContent = entry.tags.gender === "Не важно" ? "все" : "выбрано";
            document.getElementById("modalGenderLabel").dataset.value = entry.tags.gender;
            
            modalDatePicker.value = entry.tags.date === "все" ? "" : entry.tags.date;
            document.getElementById("modalDateLabel").textContent = entry.tags.date === "все" ? "все" : "выбрано";
            
            // Удаляем старую запись
            entries = entries.filter(e => e.id !== entryId);
            
            document.getElementById("modalUserInfo").innerHTML = `
              <img src="${currentUser.avatar}" alt="avatar" />
              <span>${sanitizeHtml(currentUser.name)}</span>
            `;
            
            modal.classList.add("active");
            modalOverlay.classList.add("active");
          }
        }
        closeAllDropdowns();
        return;
      }

      // Клик по пользователю
      const userInfo = e.target.closest(".user-info");
      if (userInfo) {
        const userId = parseInt(userInfo.dataset.userId);
        if (userId && window.Telegram?.WebApp) {
          window.Telegram.WebApp.openTelegramLink(`tg://user?id=${userId}`);
        }
        return;
      }
    });

    // Pull to refresh
    let startY = 0;
    let isPulling = false;

    entriesContainer.addEventListener("touchstart", e => {
      startY = e.touches[0].clientY;
      isPulling = window.scrollY === 0;
    });

    entriesContainer.addEventListener("touchmove", e => {
      if (!isPulling) return;
      const currentY = e.touches[0].clientY;
      const deltaY = currentY - startY;
      if (deltaY > 50) {
        entriesContainer.classList.add("pulling");
      }
    });

    entriesContainer.addEventListener("touchend", () => {
      if (entriesContainer.classList.contains("pulling")) {
        entriesContainer.classList.remove("pulling");
        loadingIndicator.classList.add("active");
        setTimeout(() => {
          refreshEntries();
        }, 1000);
      }
      isPulling = false;
    });

    // Закрытие выпадающих меню при клике вне их
    document.addEventListener("click", function(event) {
      if (!event.target.closest("#searchBar, #searchButton")) {
        searchBar.classList.remove("active");
      }
      if (!event.target.closest(".filter-btn, .sort-btn, .card-menu-btn, .filter-dropdown, .sort-dropdown, .card-menu-dropdown, .header-menu-dropdown, #headerMenuButton")) {
        closeAllDropdowns();
      }
    });

    // Infinite scroll
    const observer = new IntersectionObserver(entries => {
      if (entries[0].isIntersecting && !isLoading) {
        currentPage++;
        loadEntries();
      }
    }, { threshold: 0.1 });

    // Инициализация
    entries.sort((a, b) => b.timestamp - a.timestamp);
    updateTypeCheckmarks("typeDropdownMenu", selectedTypes);
    updateTypeCheckmarks("modalTypeDropdownMenu", modalSelectedTypes);
    updateTypeFilter(false);
    updateTypeFilter(true);
    refreshEntries();

    // Инициализация Telegram WebApp
    if (window.Telegram?.WebApp) {
      window.Telegram.WebApp.ready();
      window.Telegram.WebApp.expand();
      
      // Включаем отображение главной кнопки если нужно
      window.Telegram.WebApp.MainButton.hide();
      
      // Настройка цветов под тему Telegram
      if (window.Telegram.WebApp.themeParams) {
        const root = document.documentElement;
        root.style.setProperty('--tg-theme-bg-color', window.Telegram.WebApp.themeParams.bg_color || '#f8f7f6');
        root.style.setProperty('--tg-theme-text-color', window.Telegram.WebApp.themeParams.text_color || '#161618');
      }
      
      // Обработчик закрытия приложения
      window.Telegram.WebApp.onEvent('viewportChanged', function() {
        console.log('Viewport changed:', window.Telegram.WebApp.viewportHeight);
      });
      
    } else {
      console.log("Приложение запущено вне Telegram WebApp");
      // Добавляем уведомление для пользователя
      const notice = document.createElement('div');
      notice.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        background: #FF9500;
        color: white;
        padding: 8px;
        text-align: center;
        font-size: 12px;
        z-index: 1000;
      `;
      notice.textContent = 'Демо режим - для полной функциональности откройте в Telegram';
      document.body.appendChild(notice);
      
      // Добавляем отступ сверху для основного контента
      document.querySelector('.ios-header').style.top = '32px';
      document.querySelector('.main-content').style.paddingTop = '72px';
    }
  </script>
</body>
</html>
